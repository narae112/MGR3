<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org"
       xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<div layout:fragment="content">
    <h1>MGR 시작합시다</h1>
    <button class="btn btn-primary" type="button" onClick="location.href='member/admin/test'">로그인인증테스트</button>
<!--    <button class="btn btn-primary" type="button" onClick="location.href='api'">알림</button>-->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#chatModal" id="notificationButton">알림</button>

    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatModalLabel">알림</h5>
                    <button type="button" class="btn btn-danger close" style="margin-left: auto;" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="notify" style="height: 300px; overflow-y: scroll; padding: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

<!--    <button class="btn btn-primary" type="button" onClick="location.href='chatRoom'">1:1</button>-->


<!--    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#chatModal">-->
<!--        챗봇-->
<!--    </button>-->

<!--    &lt;!&ndash;챗봇 모달창&ndash;&gt;-->
<!--    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">-->
<!--        <div class="modal-dialog">-->
<!--            <div class="modal-content">-->
<!--                <div class="modal-header">-->
<!--                    <h5 class="modal-title" id="chatModalLabel">MGR 챗봇</h5>-->
<!--                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
<!--                        <span aria-hidden="true">&times;</span>-->
<!--                    </button>-->
<!--                </div>-->
<!--                <div class="modal-body">-->
<!--                    <div id="chatWindow" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">-->

<!--                    </div>-->
<!--                    <div class="input-group mt-3">-->
<!--                        <input type="text" id="userInput" class="form-control" placeholder="메세지를 입력하세요">-->
<!--                        <div class="input-group-append">-->
<!--                            <button class="btn btn-primary" type="button" id="sendButton">전송</button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
<!--        $(document).ready(function(){-->
<!--            $('#sendButton').click(function(){-->
<!--                var userMessage = $('#userInput').val();-->
<!--                if(userMessage.trim() !== "") {-->
<!--                    $('#chatWindow').append('<div class="text-right"><strong>You:</strong> ' + userMessage + '</div>');-->
<!--                    $('#userInput').val('');-->

<!--                    $.ajax({-->
<!--                        url: '/gemini/chat',-->
<!--                        type: 'GET',-->
<!--                        data: { message: userMessage },-->
<!--                        success: function(response) {-->
<!--                            $('#chatWindow').append('<div class="text-left"><strong>Gemini:</strong> ' + response + '</div>');-->
<!--                            $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);-->
<!--                        },-->
<!--                        error: function(xhr, status, error) {-->
<!--                            $('#chatWindow').append('<div class="text-left text-danger"><strong>Error:</strong> ' + xhr.responseText + '</div>');-->
<!--                            $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);-->
<!--                        }-->
<!--                    });-->
<!--                }-->
<!--            });-->
<!--            $('#sendButton').click(function(){-->
<!--                var userMessage = $('#userInput').val();-->
<!--                if(userMessage.trim() !== "") {-->
<!--                    $('#notify').append('<div class="text-right"><strong>You:</strong> ' + userMessage + '</div>');-->
<!--                    $('#userInput').val('');-->
<!--                }-->
<!--            });-->

<!--            $('#userInput').keypress(function(event){-->
<!--                if(event.which === 13){-->
<!--                    $('#sendButton').click();-->
<!--                }-->
<!--            });-->
        $(document).ready(function(){
            let eventSource;
            $('#notificationButton').click(function(){
                if (!eventSource) {
                    eventSource = new EventSource('/api');
                    eventSource.addEventListener('connect', function(event) {
                        displayMessage(event.data);
                    });
                    eventSource.addEventListener('message', function(event) {
                        displayMessage(event.data);
                    });
                    eventSource.onerror = function(event) {
                        displayMessage('EventSource failed: ' + event);
                    };

                    // DB에서 기존 알림 가져오기
                    $.ajax({
                        url: '/api/notifications',
                        type: 'GET',
                        success: function(notifications) {
                            const messagesDiv = document.getElementById('notify');
                            messagesDiv.innerHTML = ''; // 기존 알림 지우기
                            notifications.forEach(notification => {
                                displayMessage(notification.message);
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to load notifications:', error);
                        }
                    });
                }
            });

            function displayMessage(message) {
                const messagesDiv = document.getElementById('notify');
                const cardElement = document.createElement('div');
                cardElement.className = 'card mb-3';
                cardElement.innerHTML = `
                    <div class="card-body d-flex align-items-center">
                        <p class="card-text mb-0 flex-grow-1">${message}</p>
                        <button type="button" class="close ml-auto" aria-label="Close" onclick="this.closest('.card').remove();">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `;
                messagesDiv.appendChild(cardElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });

    </script>
</div>


</html>