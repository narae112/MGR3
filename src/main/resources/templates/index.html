<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org"
       xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
       xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/default}">
<div layout:fragment="content">
    <h1>MGR 시작합시다</h1>
    <button class="btn btn-primary" type="button" onClick="location.href='member/admin/test'">로그인인증테스트</button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#notificationModal" id="notificationButton">알림
        <span class="badge rounded-pill bg-danger" id="notificationCount" sec:authorize="isAuthenticated()"></span>
    </button>

    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#chatModal">챗봇</button>


    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">알림</h5>
                    <button type="button" class="btn btn-danger close" style="margin-left: auto;" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="notify" style="height: 300px; overflow-y: scroll; padding: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatModalLabel">MGR 챗봇</h5>
                    <button type="button" class="btn btn-danger close" style="margin-left: auto;" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="chatWindow" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" id="userInput" class="form-control" placeholder="메세지를 입력하세요">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button" id="sendButton">전송</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">

        var token = $("meta[name='_csrf']").attr('content');
        var header = $("meta[name='_csrf_header']").attr('content');

        function deleteNotification(id, button) {
            $.ajax({
                url: `/api/notifications/${id}`,
                type: 'DELETE',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function() {
                    button.closest('.card').remove();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to delete notification:', error);
                }
            });
        }

        $(document).ready(function() {
            $.ajax({
                url: '/api/notifications/count',
                type: 'GET',
                success: function(data) {
                    $('#notificationCount').text(data);
                },
                error: function(xhr, status, error) {
                    console.error('Failed to fetch notification count:', error);
                }
            });

            function sendMessage() {
                var userMessage = $('#userInput').val();
                if (userMessage.trim() !== "") {
                    $('#chatWindow').append('<div class="text-right"><strong>User :</strong> ' + userMessage + '</div>');
                    $('#userInput').val('');

                    $.ajax({
                        url: '/gemini/chat',
                        type: 'GET',
                        data: { message: userMessage },
                        success: function(response) {
                            $('#chatWindow').append('<div class="text-left"><strong>ChatMRG :</strong> ' + response + '</div>');
                            $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);
                        },
                        error: function(xhr, status, error) {
                            $('#chatWindow').append('<div class="text-left text-danger"><strong>Error:</strong> ' + xhr.responseText + '</div>');
                            $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);
                        }
                    });
                }
            }

            $('#sendButton').click(function() {
                sendMessage();
            });

            $('#userInput').keypress(function(event) {
                if (event.which === 13) {
                    sendMessage();
                }
            });

            let eventSource;
            $('#notificationButton').click(function() {
                if (!eventSource) {
                    eventSource = new EventSource('/api');
                    eventSource.addEventListener('connect', function(event) {
                        displayMessage(event.data, null);
                    });
                    eventSource.addEventListener('message', function(event) {
                        displayMessage(event.data, null);
                    });
                    eventSource.onerror = function(event) {
                        displayMessage('EventSource failed: ' + event, null);
                    };

                    // DB에서 기존 알림 가져오기
                    $.ajax({
                        url: '/api/notifications',
                        type: 'GET',
                        success: function(notifications) {
                            const messagesDiv = document.getElementById('notify');
                            messagesDiv.innerHTML = ''; // 기존 알림 지우기
                            notifications.forEach(notification => {
                                displayMessage(notification.message, notification.id);
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to load notifications:', error);
                        }
                    });
                }
            });

            function displayMessage(message, id) {
                const messagesDiv = document.getElementById('notify');
                const cardElement = document.createElement('div');
                cardElement.className = 'card mb-3';
                cardElement.innerHTML = `
                    <div class="card-body d-flex align-items-center">
                        <p class="card-text mb-0 flex-grow-1">${message}</p>
                        <button type="button" class="close ml-auto" aria-label="Close"
                        onclick="deleteNotification(${id}, this)">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `;
                messagesDiv.appendChild(cardElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });
    </script>
</div>


</html>